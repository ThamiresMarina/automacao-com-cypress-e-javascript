"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.composeScenarioSummary = composeScenarioSummary;
const messages_1 = require("@cucumber/messages");
const formatting_1 = require("../formatting");
const utils_1 = require("../utils");
const ERROR_INDENT_LENGTH = 4;
const ATTACHMENT_INDENT_LENGTH = 4;
/**
 * Finds all pertinent (non-passing) steps that should be shown in the summary.
 * Returns the first non-passed step, plus every subsequent step that is not passed or skipped.
 */
function findPertinentSteps(stepsWithFinished) {
    const result = [];
    let foundFirstNonPassed = false;
    for (const [testStepFinished, testStep] of stepsWithFinished) {
        const status = testStepFinished.testStepResult.status;
        if (foundFirstNonPassed) {
            if (status !== messages_1.TestStepResultStatus.PASSED && status !== messages_1.TestStepResultStatus.SKIPPED) {
                result.push([testStepFinished, testStep]);
            }
        }
        else if (status !== messages_1.TestStepResultStatus.PASSED) {
            result.push([testStepFinished, testStep]);
            foundFirstNonPassed = true;
        }
    }
    return result;
}
/**
 * Formats a single step for the summary output.
 */
function formatStep(testStepFinished, testStep, context) {
    const { query, theme, stream, includeAttachments } = context;
    const lines = [];
    const status = testStepFinished.testStepResult.status;
    if (testStep.pickleStepId) {
        const pickleStep = (0, utils_1.ensure)(query.findPickleStepBy(testStep), 'PickleStep must exist for Step with pickleStepId');
        const step = (0, utils_1.ensure)(query.findStepBy(pickleStep), 'Step must exist for PickleStep');
        const stepDefinition = query.findUnambiguousStepDefinitionBy(testStep);
        lines.push((0, utils_1.indent)((0, utils_1.join)((0, formatting_1.formatStepTitle)(testStep, pickleStep, step, status, false, theme, stream), stepDefinition?.sourceReference
            ? (0, formatting_1.formatSourceReference)(stepDefinition.sourceReference, theme, stream)
            : undefined), utils_1.GHERKIN_INDENT_LENGTH));
        if (pickleStep.argument) {
            lines.push((0, utils_1.indent)((0, formatting_1.formatPickleStepArgument)(pickleStep.argument, theme, stream), utils_1.GHERKIN_INDENT_LENGTH + utils_1.STEP_ARGUMENT_INDENT_LENGTH));
        }
        if (status === messages_1.TestStepResultStatus.AMBIGUOUS) {
            const stepDefinitions = query.findStepDefinitionsBy(testStep);
            lines.push((0, utils_1.indent)((0, formatting_1.formatAmbiguousStep)(stepDefinitions, theme, stream), utils_1.GHERKIN_INDENT_LENGTH + ERROR_INDENT_LENGTH));
        }
    }
    else if (testStep.hookId) {
        const hook = query.findHookBy(testStep);
        lines.push((0, utils_1.indent)((0, utils_1.join)((0, formatting_1.formatHookTitle)(hook, status, theme, stream), hook?.sourceReference
            ? (0, formatting_1.formatSourceReference)(hook.sourceReference, theme, stream)
            : undefined), utils_1.GHERKIN_INDENT_LENGTH));
    }
    const error = (0, utils_1.extractReportableMessage)(testStepFinished.testStepResult);
    if (error) {
        lines.push((0, utils_1.indent)((0, formatting_1.formatError)(error, status, theme, stream), utils_1.GHERKIN_INDENT_LENGTH + ERROR_INDENT_LENGTH));
    }
    if (includeAttachments) {
        const attachments = query.findAttachmentsBy(testStepFinished);
        attachments.forEach((attachment) => {
            lines.push('');
            lines.push((0, utils_1.indent)((0, formatting_1.formatAttachment)(attachment, theme, stream), utils_1.GHERKIN_INDENT_LENGTH + ATTACHMENT_INDENT_LENGTH));
        });
    }
    return lines;
}
function composeScenarioSummary(testCaseFinished, query, { includeAttachments, theme }, stream) {
    const testCaseStarted = (0, utils_1.ensure)(query.findTestCaseStartedBy(testCaseFinished), 'TestCaseStarted must exist for TestCaseFinished');
    const pickle = (0, utils_1.ensure)(query.findPickleBy(testCaseFinished), 'Pickle must exist for TestCaseFinished');
    const location = query.findLocationOf(pickle);
    const allSteps = query.findTestStepFinishedAndTestStepBy(testCaseStarted);
    const pertinentSteps = findPertinentSteps(allSteps);
    const lines = [];
    const formattedLocation = (0, formatting_1.formatPickleLocation)(pickle, location, theme, stream);
    const formattedAttempt = testCaseStarted.attempt > 0 ? `, after ${testCaseStarted.attempt + 1} attempts` : '';
    lines.push(`${pickle.name}${formattedAttempt} ${formattedLocation}`);
    const context = { query, theme, stream, includeAttachments };
    for (const [testStepFinished, testStep] of pertinentSteps) {
        lines.push(...formatStep(testStepFinished, testStep, context));
    }
    return lines.join('\n');
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcG9zZVNjZW5hcmlvU3VtbWFyeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb21wb3NpdGlvbi9jb21wb3NlU2NlbmFyaW9TdW1tYXJ5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBb0pBLHdEQWdDQztBQXBMRCxpREFLMkI7QUFHM0IsOENBU3NCO0FBRXRCLG9DQU9pQjtBQUVqQixNQUFNLG1CQUFtQixHQUFHLENBQUMsQ0FBQTtBQUM3QixNQUFNLHdCQUF3QixHQUFHLENBQUMsQ0FBQTtBQUVsQzs7O0dBR0c7QUFDSCxTQUFTLGtCQUFrQixDQUN6QixpQkFBdUU7SUFFdkUsTUFBTSxNQUFNLEdBQXdDLEVBQUUsQ0FBQTtJQUN0RCxJQUFJLG1CQUFtQixHQUFHLEtBQUssQ0FBQTtJQUUvQixLQUFLLE1BQU0sQ0FBQyxnQkFBZ0IsRUFBRSxRQUFRLENBQUMsSUFBSSxpQkFBaUIsRUFBRSxDQUFDO1FBQzdELE1BQU0sTUFBTSxHQUFHLGdCQUFnQixDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUE7UUFDckQsSUFBSSxtQkFBbUIsRUFBRSxDQUFDO1lBQ3hCLElBQUksTUFBTSxLQUFLLCtCQUFvQixDQUFDLE1BQU0sSUFBSSxNQUFNLEtBQUssK0JBQW9CLENBQUMsT0FBTyxFQUFFLENBQUM7Z0JBQ3RGLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxnQkFBZ0IsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFBO1lBQzNDLENBQUM7UUFDSCxDQUFDO2FBQU0sSUFBSSxNQUFNLEtBQUssK0JBQW9CLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDbEQsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLGdCQUFnQixFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUE7WUFDekMsbUJBQW1CLEdBQUcsSUFBSSxDQUFBO1FBQzVCLENBQUM7SUFDSCxDQUFDO0lBQ0QsT0FBTyxNQUFNLENBQUE7QUFDZixDQUFDO0FBU0Q7O0dBRUc7QUFDSCxTQUFTLFVBQVUsQ0FDakIsZ0JBQWtDLEVBQ2xDLFFBQWtCLEVBQ2xCLE9BQTBCO0lBRTFCLE1BQU0sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxrQkFBa0IsRUFBRSxHQUFHLE9BQU8sQ0FBQTtJQUM1RCxNQUFNLEtBQUssR0FBYSxFQUFFLENBQUE7SUFDMUIsTUFBTSxNQUFNLEdBQUcsZ0JBQWdCLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQTtJQUVyRCxJQUFJLFFBQVEsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUMxQixNQUFNLFVBQVUsR0FBRyxJQUFBLGNBQU0sRUFDdkIsS0FBSyxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxFQUNoQyxrREFBa0QsQ0FDbkQsQ0FBQTtRQUNELE1BQU0sSUFBSSxHQUFHLElBQUEsY0FBTSxFQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLEVBQUUsZ0NBQWdDLENBQUMsQ0FBQTtRQUNuRixNQUFNLGNBQWMsR0FBRyxLQUFLLENBQUMsK0JBQStCLENBQUMsUUFBUSxDQUFDLENBQUE7UUFFdEUsS0FBSyxDQUFDLElBQUksQ0FDUixJQUFBLGNBQU0sRUFDSixJQUFBLFlBQUksRUFDRixJQUFBLDRCQUFlLEVBQUMsUUFBUSxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsTUFBTSxDQUFDLEVBQ3pFLGNBQWMsRUFBRSxlQUFlO1lBQzdCLENBQUMsQ0FBQyxJQUFBLGtDQUFxQixFQUFDLGNBQWMsQ0FBQyxlQUFlLEVBQUUsS0FBSyxFQUFFLE1BQU0sQ0FBQztZQUN0RSxDQUFDLENBQUMsU0FBUyxDQUNkLEVBQ0QsNkJBQXFCLENBQ3RCLENBQ0YsQ0FBQTtRQUNELElBQUksVUFBVSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ3hCLEtBQUssQ0FBQyxJQUFJLENBQ1IsSUFBQSxjQUFNLEVBQ0osSUFBQSxxQ0FBd0IsRUFBQyxVQUFVLENBQUMsUUFBUSxFQUFFLEtBQUssRUFBRSxNQUFNLENBQUMsRUFDNUQsNkJBQXFCLEdBQUcsbUNBQTJCLENBQ3BELENBQ0YsQ0FBQTtRQUNILENBQUM7UUFDRCxJQUFJLE1BQU0sS0FBSywrQkFBb0IsQ0FBQyxTQUFTLEVBQUUsQ0FBQztZQUM5QyxNQUFNLGVBQWUsR0FBRyxLQUFLLENBQUMscUJBQXFCLENBQUMsUUFBUSxDQUFDLENBQUE7WUFDN0QsS0FBSyxDQUFDLElBQUksQ0FDUixJQUFBLGNBQU0sRUFDSixJQUFBLGdDQUFtQixFQUFDLGVBQWUsRUFBRSxLQUFLLEVBQUUsTUFBTSxDQUFDLEVBQ25ELDZCQUFxQixHQUFHLG1CQUFtQixDQUM1QyxDQUNGLENBQUE7UUFDSCxDQUFDO0lBQ0gsQ0FBQztTQUFNLElBQUksUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQzNCLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUE7UUFDdkMsS0FBSyxDQUFDLElBQUksQ0FDUixJQUFBLGNBQU0sRUFDSixJQUFBLFlBQUksRUFDRixJQUFBLDRCQUFlLEVBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsTUFBTSxDQUFDLEVBQzVDLElBQUksRUFBRSxlQUFlO1lBQ25CLENBQUMsQ0FBQyxJQUFBLGtDQUFxQixFQUFDLElBQUksQ0FBQyxlQUFlLEVBQUUsS0FBSyxFQUFFLE1BQU0sQ0FBQztZQUM1RCxDQUFDLENBQUMsU0FBUyxDQUNkLEVBQ0QsNkJBQXFCLENBQ3RCLENBQ0YsQ0FBQTtJQUNILENBQUM7SUFFRCxNQUFNLEtBQUssR0FBRyxJQUFBLGdDQUF3QixFQUFDLGdCQUFnQixDQUFDLGNBQWMsQ0FBQyxDQUFBO0lBQ3ZFLElBQUksS0FBSyxFQUFFLENBQUM7UUFDVixLQUFLLENBQUMsSUFBSSxDQUNSLElBQUEsY0FBTSxFQUFDLElBQUEsd0JBQVcsRUFBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxNQUFNLENBQUMsRUFBRSw2QkFBcUIsR0FBRyxtQkFBbUIsQ0FBQyxDQUMvRixDQUFBO0lBQ0gsQ0FBQztJQUVELElBQUksa0JBQWtCLEVBQUUsQ0FBQztRQUN2QixNQUFNLFdBQVcsR0FBRyxLQUFLLENBQUMsaUJBQWlCLENBQUMsZ0JBQWdCLENBQUMsQ0FBQTtRQUM3RCxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsVUFBVSxFQUFFLEVBQUU7WUFDakMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQTtZQUNkLEtBQUssQ0FBQyxJQUFJLENBQ1IsSUFBQSxjQUFNLEVBQ0osSUFBQSw2QkFBZ0IsRUFBQyxVQUFVLEVBQUUsS0FBSyxFQUFFLE1BQU0sQ0FBQyxFQUMzQyw2QkFBcUIsR0FBRyx3QkFBd0IsQ0FDakQsQ0FDRixDQUFBO1FBQ0gsQ0FBQyxDQUFDLENBQUE7SUFDSixDQUFDO0lBRUQsT0FBTyxLQUFLLENBQUE7QUFDZCxDQUFDO0FBRUQsU0FBZ0Isc0JBQXNCLENBQ3BDLGdCQUFrQyxFQUNsQyxLQUFZLEVBQ1osRUFBRSxrQkFBa0IsRUFBRSxLQUFLLEVBQTRCLEVBQ3ZELE1BQTZCO0lBRTdCLE1BQU0sZUFBZSxHQUFHLElBQUEsY0FBTSxFQUM1QixLQUFLLENBQUMscUJBQXFCLENBQUMsZ0JBQWdCLENBQUMsRUFDN0MsaURBQWlELENBQ2xELENBQUE7SUFDRCxNQUFNLE1BQU0sR0FBRyxJQUFBLGNBQU0sRUFDbkIsS0FBSyxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsQ0FBQyxFQUNwQyx3Q0FBd0MsQ0FDekMsQ0FBQTtJQUNELE1BQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUE7SUFFN0MsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLGlDQUFpQyxDQUFDLGVBQWUsQ0FBQyxDQUFBO0lBQ3pFLE1BQU0sY0FBYyxHQUFHLGtCQUFrQixDQUFDLFFBQVEsQ0FBQyxDQUFBO0lBRW5ELE1BQU0sS0FBSyxHQUFhLEVBQUUsQ0FBQTtJQUUxQixNQUFNLGlCQUFpQixHQUFHLElBQUEsaUNBQW9CLEVBQUMsTUFBTSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUE7SUFDL0UsTUFBTSxnQkFBZ0IsR0FDcEIsZUFBZSxDQUFDLE9BQU8sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsZUFBZSxDQUFDLE9BQU8sR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFBO0lBQ3RGLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxNQUFNLENBQUMsSUFBSSxHQUFHLGdCQUFnQixJQUFJLGlCQUFpQixFQUFFLENBQUMsQ0FBQTtJQUVwRSxNQUFNLE9BQU8sR0FBc0IsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxrQkFBa0IsRUFBRSxDQUFBO0lBQy9FLEtBQUssTUFBTSxDQUFDLGdCQUFnQixFQUFFLFFBQVEsQ0FBQyxJQUFJLGNBQWMsRUFBRSxDQUFDO1FBQzFELEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxVQUFVLENBQUMsZ0JBQWdCLEVBQUUsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUE7SUFDaEUsQ0FBQztJQUVELE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTtBQUN6QixDQUFDIn0=